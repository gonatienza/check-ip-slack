#!/bin/bash
#Script to check ip address changes and push as notification with pushover

IP_FILE=/var/check-ip/current-ip
APP_TOKEN=
USER_KEY=
INTERFACE=eth0

while :
do
        IP=$(sed -n 's/^[0-9].*/&/gp' $IP_FILE)
        while [ "$IP" == "$(ifconfig $INTERFACE | sed -n 's/.*inet\saddr:\([^ ]*\).*/\1/gp')" ] || [ "" == "$(ifconfig $INTERFACE | sed -n 's/.*inet\saddr:\([^ ]*\).*/\1/gp')" ]
        do
                sleep 1h
        done

	echo "#Generated by check-ip" > "$IP_FILE"
        echo "Subject: $HOSTNAME has a new IP address" >>"$IP_FILE"
        echo "New IP Address:" >> "$IP_FILE"
        ifconfig $INTERFACE | sed -n 's/.*inet\saddr:\([^ ]*\).*/\1/gp' >> "$IP_FILE"

        curl -s \
        --form-string "token=$APP_TOKEN" \
        --form-string "user=$USER_KEY" \
        --form-string "message=$(date;cat $IP_FILE)" \
        https://api.pushover.net/1/messages.json

        logger check-ip detected new ip address.  Pushover notification sent.
        sleep 10s
done
